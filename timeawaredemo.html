<!DOCTYPE html>

<html>
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta content="IE=7, IE=9, IE=10" http-equiv="X-UA-Compatible">
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples 
      on iOS devices-->
    <meta content="initial-scale=1, maximum-scale=1,user-scalable=no" name=
    "viewport">

    <title>Image Service - Time</title>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <link href="http://js.arcgis.com/3.7/js/dojo/dijit/themes/soria/soria.css"
    rel="stylesheet">
    <link href="http://js.arcgis.com/3.7/js/esri/css/esri.css" rel=
    "stylesheet">
    
    <style>
      html,body, #map {
      height:100%;
      width:100%;
      margin:0;
      padding:0;
      }

      
      #HomeButton {
      position: absolute;
      top: 95px;
      left: 20px;
      z-index: 50;
      }
      .shadow {
      -moz-border-radius:2px;
      -webkit-border-radius:2px;
      -moz-box-shadow:0 0px 0px 0px #888;
      -webkit-box-shadow:0 0px 0px 0px #888;
      box-shadow:0 0px 0px 0px #888;
      background-color:rgba(52,71,88, .70);
      padding:8px;
      }

      .timeWindow {
      -moz-border-radius:2px;
      position:absolute;
      right:500px;
      bottom:5px;
      /*right:35px;*/
      /*top:5px;*/
      z-index:998;
      width:700px;
      -webkit-border-radius:2px;
      background: rgba(52,71,88, .70);
      font-family:Roboto;
      color:#FFF;
      text-align:left;
      padding:1px;
      }

      #title {
      font-size:20pt;
      font-weight:700;
      }

      #subTitle {
      font-size:18pt;
      }

      #overlay {
        float: right;
      }
      #details {
        border-top: 1px dotted #fff;
        width: 100%
      }

      #details p{
        
        font-size:10pt;
        margin: 0;

      display: inline-block;
      cursor: pointer;
      }
      #details .site:hover{
        color: #F2A622;
      }

      
    </style>

    <script>var djConfig = { parseOnLoad: true };</script>
    <script src="http://js.arcgis.com/3.7/"></script>
    <script>
        dojo.require("dijit.layout.BorderContainer");
        dojo.require("dijit.layout.ContentPane");
        dojo.require("esri.dijit.TimeSlider");
        dojo.require("esri.dijit.HomeButton");
        dojo.require("esri.map");
        dojo.require("esri.layers.ArcGISImageServiceLayer");


        var map, 
            myTimeStepIntervals = [],   
            // Masonville
            masonCenter = [-76.5873, 39.2470],
            masonZoom = 16,
            masonImageService = "http://staging.mesgis.com:6080/arcgis/rest/services/MPA/Masonville/ImageServer",         
            // Cox Creek
            coxCenter = [-76.5320, 39.1975],
            coxZoom = 16,
            coxImageService = "http://staging.mesgis.com:6080/arcgis/rest/services/MPA/CoxCreek/ImageServer",
            //Poplar Island
            poplarCenter = [-76.3818, 38.7590],
            poplarZoom = 15
            //Hart-Miller Island
            hmiCenter = [-76.3665, 39.2483],
            hmiZoom = 15;

        function init() {
            siteName = 'MPA Image Viewer';
            map = new esri.Map("map", {
                //extent: initMasonExtent,
                basemap: "topo",
                center: [-77.322, 38.860],
                zoom: 9,
                isClickRecenter: true,
                navigationMode: 'classic'
            });

            var home = new esri.dijit.HomeButton({
                map: map,
                
            }, "HomeButton");

            home.startup(updateTitle(siteName));

            var params = new esri.layers.ImageServiceParameters();
            params.noData = 0;

            var masonImageServiceLayer = new esri.layers.ArcGISImageServiceLayer(masonImageService, {
                imageServiceParameters: params,
                hasAttributionData: true
            });
            var coxImageServiceLayer = new esri.layers.ArcGISImageServiceLayer(coxImageService, {
                imageServiceParameters: params,
                hasAttributionData: true
            });

            $("#masonville").click(function() {
                siteName = 'Masonville';
                updateTitle(siteName);  
                myTimeStepIntervals.length = 0;
                map.centerAndZoom(masonCenter, masonZoom);
                //map.setZoom(masonZoom);
                map.addLayer(masonImageServiceLayer);
                
                var query = new esri.tasks.Query();
                query.where = "1=1";
                query.outFields = ["Date"];
                query.returnGeometry = false;
                var queryTask = new esri.tasks.QueryTask(masonImageService);

                // Query for the image dates and put them in an array
                queryTask.execute(query, function(featureSet) {
                    //alert(featureSet.features[0].attributes.Date);
                    var resultSet = featureSet.features;

                    for (var i = 0, il = resultSet.length; i < il; i++) {
                        var interval = resultSet[i].attributes.Date;
                        myTimeStepIntervals.push(new Date(interval));
                    }
                    //alert(myTimeStepIntervals.length);
                    initSlider(masonImageServiceLayer);
                });
            });

            $("#cox-creek").click(function() {
                siteName = 'Cox Creek';
                updateTitle(siteName);
                
                myTimeStepIntervals.length = 0;
                map.centerAndZoom(coxCenter, coxZoom);
                map.addLayer(coxImageServiceLayer);

                 var query = new esri.tasks.Query();
                query.where = "1=1";
                query.outFields = ["Date"];
                query.returnGeometry = false;
                var queryTask = new esri.tasks.QueryTask(coxImageService);

                // Query for the image dates and put them in an array
                queryTask.execute(query, function(featureSet) {
                    //alert(featureSet.features[0].attributes.Date);
                    var resultSet = featureSet.features;

                    for (var i = 0, il = resultSet.length; i < il; i++) {
                        var interval = resultSet[i].attributes.Date;
                        myTimeStepIntervals.push(new Date(interval));
                    }
                    //alert(myTimeStepIntervals.length);
                    initSlider(coxImageServiceLayer);      
                });
            });
            
        $("#poplar-island").click(function() {
            siteName = 'Poplar Island';
            updateTitle(siteName);
            myTimeStepIntervals.length = 0;
            map.centerAndZoom(poplarCenter, poplarZoom);
        });

        $("#hart-miller").click(function() {
            siteName = 'Hart-Miller Island';
            updateTitle(siteName);
            myTimeStepIntervals.length = 0;
            map.centerAndZoom(hmiCenter, hmiZoom);
        });
    }
        
        function updateTitle(){
            $(document).ready(function () {
                $('#title').html(siteName);
            });
        }

        
        function initSlider(results) {

                // Destroy existing time slider
                if (dijit.byId('timeSlider')) {
                    //alert('Exterminate!');
                    dijit.byId('timeSlider').destroy();
                }
                // Create a new time slider
                var tsDiv = dojo.create("div", null, dojo.byId('timeSliderDiv'));
                var timeSlider = new esri.dijit.TimeSlider({
                    style: "width:100%;",
                    id: 'timeSlider'
                }, tsDiv);
                map.setTimeSlider(timeSlider);
                //var myTimeStepIntervals = [new Date("1/1/2005 6:00:01 UTC"), new Date("1/1/2007 6:00:01 UTC"), new Date("11/7/2007 6:00:01 UTC"), new Date("3/29/2008 6:00:01 UTC")];
                var timeExtent = new esri.TimeExtent();
                timeSlider.setThumbCount(1);
                
                // Set the slider intervals to dates in the raster mosaic
                timeSlider.setTimeStops(myTimeStepIntervals);
                timeExtent = results.timeInfo.timeExtent;
                var attTable = results.getRasterAttributeTable(function() {
                    alert('success')
                }, function() {
                    alert('fail')
                });
                //timeSlider.createTimeStopsByTimeInterval(timeExtent, 1, 'esriTimeUnitsMonths');

                timeSlider.setThumbMovingRate(2000);
                timeSlider.singleThumbAsTimeInstant(true);
                timeSlider.startup();
                dojo.connect(timeSlider, "onTimeExtentChange", function(timeExtent) {
                    dojo.byId("subTitle").innerHTML = dojo.string.substitute("${endTime}", timeExtent, function(val) {
                        return dojo.date.locale.format(val, {
                            selector: 'date',
                            datePattern: 'MMMM dd yyyy'
                        });
                    });
                });
        }
    
        dojo.ready(init);
    </script>
  </head>
  
  <body class="soria">
    <div data-dojo-type="dijit.layout.BorderContainer" 
         data-dojo-props="design:'headline', gutters:false"
         style="width: 100%; height: 100%; margin: 0;">

      <div id="map" 
           data-dojo-type="dijit.layout.ContentPane" 
           data-dojo-props="region:'center'" 
           style="overflow:hidden;position:relative;">
        <div id="HomeButton"></div>
        <div class="timeWindow">
          <div id="timeSliderWin" class="shadow">
            <div id="title"></div>
            <div id="subTitle"></div>
            
            <div id="timeSliderDiv" style="width:100%;height:100%;"></div>
            <div id="details">
                <p id="zoom">Zoom to: </p>
                <p id="masonville" class="site">Masonville</p>
                <p>|</p>
                <p id="cox-creek" class="site">Cox Creek</p>
                <p>|</p>
                <p id="poplar-island" class="site">Poplar Island</p>
                <p>|</p>
                <p id="hart-miller" class="site">Hart-Miller Island</p>
                <div id="overlay">
                <input type="checkbox" id="showshoreline" class="shorelinecheck" value="shoreline">
                <label for="showshoreline" id="shoreline-label">Show Shorelines</label>
            </div>
            </div>
            
          </div>
        </div>
      </div>
     </div>
  </body>

</html>